name: Release and Publish

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm

      - run: npm ci

      - run: npm run compile

      - run: npm test
        env:
          DISPLAY: ':99'

      - run: npx @vscode/vsce package --no-dependencies

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Extract changelog section
        id: changelog
        run: |
          version="${{ steps.version.outputs.version }}"
          section=$(sed -n "/^## \[${version}\]/,/^## \[/p" CHANGELOG.md | head -n -1)
          if [ -z "$section" ]; then
            section="Release v${version}"
          fi
          {
            echo "body<<CHANGELOG_EOF"
            echo "$section"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Detect pre-release
        id: prerelease
        run: |
          version="${{ steps.version.outputs.version }}"
          if echo "$version" | grep -qE '(alpha|beta|rc)'; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.changelog.outputs.body }}
          files: "*.vsix"
          prerelease: ${{ steps.prerelease.outputs.is_prerelease }}

  publish-marketplace:
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: npm

      - run: npm ci

      - run: npm run compile

      - name: Publish to VS Code Marketplace
        run: npx @vscode/vsce publish --no-dependencies -p "$VSCE_PAT"
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to OpenVSX
        run: npx ovsx publish --no-dependencies -p "$OVSX_PAT"
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
